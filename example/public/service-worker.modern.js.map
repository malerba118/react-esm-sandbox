{"version":3,"file":"service-worker.modern.js","sources":["../../node_modules/promise-worker/register.js","../../src/interpreter/types.ts","../../src/interpreter/service-worker.ts"],"sourcesContent":["'use strict'\n\nfunction isPromise (obj) {\n  // via https://unpkg.com/is-promise@2.1.0/index.js\n  return !!obj && (typeof obj === 'object' || typeof obj === 'function') && typeof obj.then === 'function'\n}\n\nfunction registerPromiseWorker (callback) {\n  function postOutgoingMessage (e, messageId, error, result) {\n    function postMessage (msg) {\n      /* istanbul ignore if */\n      if (typeof self.postMessage !== 'function') { // service worker\n        e.ports[0].postMessage(msg)\n      } else { // web worker\n        self.postMessage(msg)\n      }\n    }\n    if (error) {\n      /* istanbul ignore else */\n      if (typeof console !== 'undefined' && 'error' in console) {\n        // This is to make errors easier to debug. I think it's important\n        // enough to just leave here without giving the user an option\n        // to silence it.\n        console.error('Worker caught an error:', error)\n      }\n      postMessage([messageId, {\n        message: error.message\n      }])\n    } else {\n      postMessage([messageId, null, result])\n    }\n  }\n\n  function tryCatchFunc (callback, message) {\n    try {\n      return { res: callback(message) }\n    } catch (e) {\n      return { err: e }\n    }\n  }\n\n  function handleIncomingMessage (e, callback, messageId, message) {\n    var result = tryCatchFunc(callback, message)\n\n    if (result.err) {\n      postOutgoingMessage(e, messageId, result.err)\n    } else if (!isPromise(result.res)) {\n      postOutgoingMessage(e, messageId, null, result.res)\n    } else {\n      result.res.then(function (finalResult) {\n        postOutgoingMessage(e, messageId, null, finalResult)\n      }, function (finalError) {\n        postOutgoingMessage(e, messageId, finalError)\n      })\n    }\n  }\n\n  function onIncomingMessage (e) {\n    var payload = e.data\n    if (!Array.isArray(payload) || payload.length !== 2) {\n      // message doens't match communication format; ignore\n      return\n    }\n    var messageId = payload[0]\n    var message = payload[1]\n\n    if (typeof callback !== 'function') {\n      postOutgoingMessage(e, messageId, new Error(\n        'Please pass a function into register().'))\n    } else {\n      handleIncomingMessage(e, callback, messageId, message)\n    }\n  }\n\n  self.addEventListener('message', onIncomingMessage)\n}\n\nmodule.exports = registerPromiseWorker\n","export type SourceFiles = Record<string, SourceFile>\n\nexport type SourceFile = {\n  contents: string\n}\n\nexport enum InterpreterEventType {\n  FilesUpdated = 'FilesUpdated',\n  Unmounted = 'Unmounted'\n}\n\nexport type InterpreterEvent<\n  EventType extends InterpreterEventType = InterpreterEventType,\n  Payload = any\n> = {\n  interpreterId: string\n  type: EventType\n  payload?: Payload\n}\n\nexport type FilesUpdatedEvent = InterpreterEvent<\n  InterpreterEventType.FilesUpdated,\n  SourceFiles\n>\n\nexport type UnmountedEvent = InterpreterEvent<\n  InterpreterEventType.Unmounted,\n  undefined\n>\n","import registerPromiseWorker from 'promise-worker/register'\nimport { InterpreterEventType, InterpreterEvent } from './types'\n\nconst sw: any = self\n\nlet interpreterSourceFiles = {}\n\nregisterPromiseWorker(({ interpreterId, type, payload }: InterpreterEvent) => {\n  console.log(type)\n  console.log(payload)\n  if (type === InterpreterEventType.FilesUpdated) {\n    interpreterSourceFiles[interpreterId] = payload\n    console.log(interpreterSourceFiles)\n  }\n})\n\nsw.addEventListener('install', function () {\n  sw.skipWaiting()\n})\n\nsw.addEventListener('fetch', function (event: any) {\n  console.log(event)\n  console.log(event.request.url)\n  Object.keys(interpreterSourceFiles).forEach((interpreterId) => {\n    Object.keys(interpreterSourceFiles[interpreterId]).forEach((filePath) => {\n      console.log(`${interpreterId}/${filePath}`)\n      if (event.request.url.endsWith(`${interpreterId}/${filePath}`)) {\n        return event.respondWith(\n          new Response(\n            interpreterSourceFiles[interpreterId][filePath].contents,\n            {\n              headers: { 'Content-Type': 'application/javascript' }\n            }\n          )\n        )\n      }\n    })\n  })\n  event.respondWith(fetch(event.request))\n})\n"],"names":["InterpreterEventType","sw","self","interpreterSourceFiles","callback","postOutgoingMessage","e","messageId","error","result","postMessage","msg","ports","console","message","addEventListener","payload","data","Array","isArray","length","obj","res","err","tryCatchFunc","then","finalResult","finalError","handleIncomingMessage","registerPromiseWorker","interpreterId","type","log","FilesUpdated","skipWaiting","event","request","url","Object","keys","forEach","filePath","endsWith","respondWith","Response","contents","headers","Content-Type","fetch"],"mappings":"AA6EA,ICvEYA,GAAZ,SAAYA,GACVA,8BACAA,wBAFF,CAAYA,IAAAA,aCHNC,EAAUC,KAEhB,IAAIC,EAAyB,IFE7B,SAAgCC,GAC9B,SAASC,EAAqBC,EAAGC,EAAWC,EAAOC,GACjD,SAASC,EAAaC,GAEY,mBAArBT,KAAKQ,YACdJ,EAAEM,MAAM,GAAGF,YAAYC,GAEvBT,KAAKQ,YAAYC,GAGjBH,GAEqB,oBAAZK,SAA2B,UAAWA,SAI/CA,QAAQL,MAAM,0BAA2BA,GAE3CE,EAAY,CAACH,EAAW,CACtBO,QAASN,EAAMM,YAGjBJ,EAAY,CAACH,EAAW,KAAME,IA6ClCP,KAAKa,iBAAiB,UAjBtB,SAA4BT,GAC1B,IAAIU,EAAUV,EAAEW,KACXC,MAAMC,QAAQH,IAA+B,IAAnBA,EAAQI,QAlBzC,SAAgCd,EAAGF,EAAUG,EAAWO,GACtD,IAxCgBO,EAwCZZ,EATN,SAAuBL,EAAUU,GAC/B,IACE,MAAO,CAAEQ,IAAKlB,EAASU,IACvB,MAAOR,GACP,MAAO,CAAEiB,IAAKjB,IAKHkB,CAAapB,EAAUU,GAEhCL,EAAOc,IACTlB,EAAoBC,EAAGC,EAAWE,EAAOc,OA3C3BF,EA4CMZ,EAAOa,MA1CC,iBAARD,GAAmC,mBAARA,GAA2C,mBAAbA,EAAII,KA2CjFpB,EAAoBC,EAAGC,EAAW,KAAME,EAAOa,KAE/Cb,EAAOa,IAAIG,KAAK,SAAUC,GACxBrB,EAAoBC,EAAGC,EAAW,KAAMmB,IACvC,SAAUC,GACXtB,EAAoBC,EAAGC,EAAWoB,KAkBpCC,CAAsBtB,EAAGF,EAPXY,EAAQ,GACVA,EAAQ,OEzD1Ba,CAAsB,EAAGC,cAAAA,EAAeC,KAAAA,EAAMf,QAAAA,MAC5CH,QAAQmB,IAAID,GACZlB,QAAQmB,IAAIhB,GACRe,IAAS/B,EAAqBiC,eAChC9B,EAAuB2B,GAAiBd,EACxCH,QAAQmB,IAAI7B,MAIhBF,EAAGc,iBAAiB,UAAW,WAC7Bd,EAAGiC,gBAGLjC,EAAGc,iBAAiB,QAAS,SAAUoB,GACrCtB,QAAQmB,IAAIG,GACZtB,QAAQmB,IAAIG,EAAMC,QAAQC,KAC1BC,OAAOC,KAAKpC,GAAwBqC,QAASV,IAC3CQ,OAAOC,KAAKpC,EAAuB2B,IAAgBU,QAASC,IAE1D,GADA5B,QAAQmB,OAAOF,KAAiBW,KAC5BN,EAAMC,QAAQC,IAAIK,YAAYZ,KAAiBW,KACjD,OAAON,EAAMQ,YACX,IAAIC,SACFzC,EAAuB2B,GAAeW,GAAUI,SAChD,CACEC,QAAS,CAAEC,eAAgB,iCAOvCZ,EAAMQ,YAAYK,MAAMb,EAAMC"}